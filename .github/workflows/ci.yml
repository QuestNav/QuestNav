name: CI

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # ============================================================
  # DETECT CHANGES
  # ============================================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      java-changed: ${{ steps.changes.outputs.java }}
      csharp-changed: ${{ steps.changes.outputs.csharp }}
      proto-changed: ${{ steps.changes.outputs.proto }}
      docs-changed: ${{ steps.changes.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            java:
              - 'questnav-lib/**'
            csharp:
              - 'unity/**'
            proto:
              - 'protos/**'
            docs:
              - 'docs/**'


# ----------------------- JAVA ----------------------- #
  format-java:
    if: needs.detect-changes.outputs.java-changed == 'true'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-format-java.yml

  docs-java:
    if: needs.detect-changes.outputs.java-changed == 'true'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-docs-javadoc.yml

  build-java:
    if: |
      (needs.detect-changes.outputs.java-changed == 'true' ||
      needs.detect-changes.outputs.csharp-changed == 'true') &&
      (needs.format-java.result != 'failed' ||
      needs.docs-java.result != 'failed')
    needs: [detect-changes, format-java, docs-java]
    uses: ./.github/workflows/reusable-build-java.yml

  # publish-javadocs:
  #   if: |
  #     needs.detect-changes.outputs.java-changed == 'true' &&
  #     needs.detect-changes.outputs.csharp-changed == 'false' &&
  #     github.ref == 'refs/heads/main'
  #   needs: [detect-changes, docs-java]
  #   uses: ./.github/workflows/reusable-publish-docs.yml
  #   with:
  #     docs-type: javadoc
  #     artifact-name: ${{ needs.docs-java.outputs.artifact-name }}
  #   permissions:
  #     contents: write

# ----------------------- C# ----------------------- #
  format-csharp:
    if: needs.detect-changes.outputs.csharp-changed == 'true'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-format-csharp.yml

  docs-csharp:
    if: needs.detect-changes.outputs.csharp-changed == 'true'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-docs-docfx.yml

  build-csharp:
    if: |
      (needs.detect-changes.outputs.csharp-changed == 'true' ||
      needs.detect-changes.outputs.java-changed == 'true') &&
      (needs.format-csharp.result != 'failed' ||
      needs.docs-csharp.result != 'failed')
    needs: [detect-changes, docs-csharp, format-csharp]
    uses: ./.github/workflows/reusable-build-csharp.yml
    secrets:
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

  # publish-docfx:
  #   if: |
  #     needs.detect-changes.outputs.csharp-changed == 'true' &&
  #     needs.detect-changes.outputs.java-changed == 'false' &&
  #     github.ref == 'refs/heads/main'
  #   needs: [detect-changes, docs-csharp]
  #   uses: ./.github/workflows/reusable-publish-docs.yml
  #   with:
  #     docs-type: docfx
  #     artifact-name: ${{ needs.docs-csharp.outputs.artifact-name }}
  #   permissions:
  #     contents: write

# ----------------------- PROTOBUF ----------------------- #
  docs-proto:
    if: needs.detect-changes.outputs.proto-changed == 'true'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-docs-proto.yml

  build-proto-java:
    if: |
      needs.detect-changes.outputs.proto-changed == 'true' &&
      needs.docs-proto.result != 'failed'
    needs: [detect-changes, docs-proto]
    uses: ./.github/workflows/reusable-build-proto-java.yml

  build-proto-csharp:
    if: |
      needs.detect-changes.outputs.proto-changed == 'true' &&
      needs.docs-proto.result != 'failed'
    needs: [detect-changes, docs-proto]
    uses: ./.github/workflows/reusable-build-proto-csharp.yml

  # publish-proto-docs:
  #   if: |
  #     needs.detect-changes.outputs.proto-changed == 'true' &&
  #     github.ref == 'refs/heads/main'
  #   needs: [detect-changes, docs-proto]
  #   uses: ./.github/workflows/reusable-publish-docs.yml
  #   with:
  #     docs-type: proto
  #     artifact-name: ${{ needs.docs-proto.outputs.artifact-name }}
  #   permissions:
  #     contents: write

  # ----------------------- DOCS ----------------------- #
  build-docs:
    if: needs.detect-changes.outputs.docs-changed == 'true'
    needs: [detect-changes]
    uses: ./.github/workflows/reusable-build-docs.yml

  # publish-main-docs:
  #   if: |
  #     needs.detect-changes.outputs.docs-changed == 'true' &&
  #     github.ref == 'refs/heads/main'
  #   needs: [detect-changes, build-docs]
  #   uses: ./.github/workflows/reusable-publish-docs.yml
  #   with:
  #     docs-type: main
  #     artifact-name: ${{ needs.build-docs.outputs.artifact-name }}
  #   permissions:
  #     contents: write

  # ----------------------- SUMMARY ----------------------- #
  ci-summary:
    if: always()
    needs:
      - detect-changes
      - format-java
      - build-java
      - docs-java
      - format-csharp
      - build-csharp
      - docs-csharp
      - build-proto-java
      - build-proto-csharp
      - docs-proto
      - build-docs
    runs-on: ubuntu-latest
    steps:
      - name: Generate CI Summary
        run: |
          echo "# CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "- Java: \`${{ needs.detect-changes.outputs.java-changed }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- C#: \`${{ needs.detect-changes.outputs.csharp-changed }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Proto: \`${{ needs.detect-changes.outputs.proto-changed }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Docs: \`${{ needs.detect-changes.outputs.docs-changed }}\`" >> $GITHUB_STEP_SUMMARY